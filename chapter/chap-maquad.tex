\chapter{基于中轴线的2维四边形网格生成}\label{chap:maquad}
输入一个2维的边界不自交的有界区域，本章的目标是自动地在此区域上生成质量较高的四边形网格。若区域的边界是曲线，我们在边界上采点，用简单多边形逼近原边界。四边形网格生成分为两步：\ref{sec:ma_subdivion}节用(ref 2d fem mesh generation)的方法，基于区域的中轴线把它分割成充分简单、可直接产生四边形网格的子区域，\ref{sec:prime_meshing}节先把子区域分割3、4、5边形结构，再利用(ref integer programming)整数规划的方法在每个子区域上产生四边形网格，并使得子区域网格之间彼此相容。
\section{中轴线的概念}\label{sec:ma}
\begin{definition}\label{def:ma}
考虑2维区域$A$以及它的边界$\partial A$,对任意点$P\in A$，记圆$U_r(P)$是以$P$为圆心在$A$中的最大圆。所有$U_r(P)$与$\partial A$交点至少为两个的点$P$构成的集合$M(A)$称为的\textbf{中轴线}。其中$U_r(P)$交于相同的两条边界的点P形成一条\textbf{中轴边}，中轴边的端点称为\textbf{中轴点}。
\end{definition}
中轴边和中轴点可被看成一个图的边和点，这个图就像$A$的骨架，代表了A的拓扑结构，因此可以作为区域分割的指导。
\begin{figure}[t]
	\centerline
	{
		\begin{overpic}[width=0.8\columnwidth]{fertility_hex_cmp}
			\put(16,48){\textbf{test my 标注}}
			\put(62,50){\textbf{(b)}}
			\put(20,-3){\textbf{(c)}}
			\put(62,-3){\textbf{(d)}}
		\end{overpic}
	}
	\vspace{4mm}
	\caption{Fertity模型上使用不同的多立方体结构构造算法生成的六面体网格。(a)，(b)，(c)，(d)分别来自\cite{Gregson2011}，~\cite{Huang2014}，~\cite{Livesu2013}，我们的方法。六面体的数目分别是19870，53702，17910，24920。缩放Jacobian行列式的最小和平均值分别为(0.196,0.911)，(0.260,0.872)，(0.312,0.911)，(0.422,0.917)。}
	\label{fig:fertility_hex_cmp}
	\vspace{-3mm}
\end{figure}

%为了根据中轴线的结构把子区域归为简单区域(\ref{def:prime})的一种或对它进一步细分,
\begin{definition} \label{medial-vertex}
与(ref fem2d)等价地，我们把中轴点分为如下几类：%根据(ref ma),中轴点是对应不同分割的中轴线的交点，分为：
	(1)J类：至少三条中轴边的交点;
	
	(2)I类：两条中轴边的交点;
	
	(3)C类：中轴边与区域边界的交点;
	
	(4)T类：拓扑冗余，中轴边的终点，与边界无交点;
\end{definition}
\todo{图}中给出了各类中轴点的示例。(ref fem2d)通过Delaunay三角化用三角形的外心连线逼近区域的中轴线，并根据三角形的邻接关系定义了与本文对应的几类三角形。本文利用CGAL库(refCGAL)精确地计算了中轴线。 
\section{基于中轴线的简单子区域的产生}\label{sec:ma_subdivion}
本节复现了(ref 2d fem mesh generation)的方法，\ref{sec:cocavity-removal}先把区域分割为凸子区域的并，\ref{ma-prime}再根据凸子区域的中轴线结构进一步把它们细分为充分简单区域的并。\ref{sec:discuss}对这种方法进行了讨论。
\subsection{分割区域去除凹角}\label{sec:cocavity-removal}
我们希望最终产生的每个四边形元素都接近矩形，且2维区域边界的拐角必然成为四边形网格的点，因此首先根据角度对它们进行分类，以在附近产生最优的四边形分布。对每个角$\theta$,提出如下的准则：
\begin{equation} \label{equ:angle-judge}
\begin{split}
\min  &{\sum_{i=1}^n(\theta_i-\frac{\pi}{2})^2}\\
s.t.\,  &\sum_{i=1}^{n}\theta_i=\theta\\
\end{split}
\end{equation}
即我们希望合理地分割$\theta$使得附近的四边形尽量好，由这个准则可以把$\theta$分为3类(\todo{可画出表格或示意图})：
\begin{enumerate}	
\item \,$\theta < 120^o,n=0$,度为1;

\item \,$120^o \leq \theta < 216^o,n=1$,度为2;

\item \,$216^o \leq \theta,n=2$,度为3;
\end{enumerate}
ref(2d fem)称第3类角是\emph{凹}的，即
\begin{definition}\label{def:concave}
	角$\theta$ 是凹的，是指$\theta \geq 216^o$
\end{definition}
%根据中轴线的定义(ref def ma)，小角附近的中轴线即为角平分线，因此大于
显然(1)的角可直接作为一个四边形的角，而(2)的角可被视为平角，让四边形直接通过附近的边界，\ref{sec:quad-meshing}节将利用整数规划直接处理。但我们必须先合理地分割区域，使产生的子区域都只有(1),(2)类的角，根据\ref{equ:angle-judge}式，它们应尽量接近直角的整数倍。

(ref fem)先在边界细致地采点，再以它们为约束对区域进行Delaunay三角化，然后从凹角点所在的内部边中选出最优的分割。选取的准则为
\begin{equation} \label{equ:split-concave}
\min \sum_{i=1}^{4}(\theta_i-\frac{n_i\pi}{2})^2+\mu \left |v-c\right |^2
\end{equation}
其中$n_i$是整数，$\theta_i$\todo{如图所示}。与(ref fem2d)不同的是，我们加入了对另一个点$v$与其最近拐点$c$的距离的惩罚。因为这个点和附近拐点之间的边会成为至少一个四边形的边界，为了避免生成的网格过密，如果角度最优的分割点离另一个拐点很近，我们选择次优的角度，直接连接两个拐角点。  
我们不断选取边进行分割，并更新子区域的Delaunay三角化，直到所有的子区域都没有凹角为止。
\subsection{基于中轴线的区域细分}\label{ma-prime}
给定一个所有拐点都不是凹角的2维区域，其中轴线就像该区域的"骨架"，并且很好地代表了区域的拓扑结构。根据\ref{sec:classify-mv}对中轴点的分类以及它们的连接关系，我们采取如下的一系列方法把这些子区域归结或进一步细分为简单区域(ref def simple)。
\begin{enumerate}[option]
	\item\textbf{T类}\,对$T$类中轴点附近区域的处理取决于沿着形成这段冗余拓扑结构的"圆弧"长成的角度总和，若它接近$\pi$,则插入一段分割分开这段"圆弧"和剩余的几何区域，一方面此"圆弧"和插入的分割形成了一个2-边界简单区域，另一方面剩余的几何区域减少了一个$T$类中轴点，并增加了两个$C$类点。若整个区域只有一个中轴点$T$,则这个区域被视为1-边界简单区域。其他的情况$T$均可被视为\ref{sec:concavity-removal}中第二类拐角点:
	
	\item\textbf{F类}\,若$C$类中轴点是ref{sec:concavity removal}中第二类拐角点，我们重新称它为$F$点，任何与$F$点相连的$J$点被重新定义为$FJ$点，即由$F-J$转化为$FJ$，四边形网格将沿此处连续地通过(\todo{图})。$FJ$或$I$点意味着两条边被合并为一条逻辑上的边，因此在所有的操作中，我们忽略任何的$FJ$或$I$点，直接考察与它们相连的$C,F,J$点。
	
	\item\textbf{C类}\,若$C$点与$T$或$F$点相连，则此区域为1-边界简单区域(图)，若与$C$点相连，则此区域为2-边界简单区域(\todo{图})，若与$J$点相连，则我们之间考察：
	
	\item\textbf{J类}\,若$J$点与$F$点相连，则更改$J$为$FJ$点，若与三个$C$点相连，则此区域为3-边界简单区域，若$J$点与两个$C$点相连，则被重新定义为$E$点，并忽略这两个$C$点(\todo{图})。产生所有的$E$点后，我们考查与剩余$J$点相邻的$C,E$点个数：若有一个$C$，两个$E$,则此区域为5-边界简单区域，若有三个$E$,则此区域为6-边界简单区域。若不满足如上所有情况，则此区域不能直接归为简单区域，将在(6)中处理。
	
	\item\textbf{E类}\, 若与$E$相连的点为$C$点，则此区域为3-边界简单区域，而$E-E$结构的区域为4-边界简单区域。
	
	\item\textbf{长链分割}\,以上操作后若还有$J-J$结构，则需要产生合适的分割，在分割两侧分别产生两个$E$点，分割后产生的两个子区域又可以归结为简单区域。若这条中轴线对应的边界有$F$点，则我们使用准则\ref{equ:split-concave}再次从Delaunay三角形中选取分割，此时$F$点被当作凹点处理。若无边界点，则以中轴线上的点为圆心，沿着中轴线产生一系列内接圆，并以长度为极值的直径作为分割(\todo{图})。
	
	\item\textbf{圆环}\,最后我们要检查是否有逻辑上的圆环结构存在，若有，则我们类似(6)产生两条分割，即可产生两个$E-E$结构，即4-边界简单区域。
\end{enumerate}
%(1)\textbf{T类}\,对$T$类中轴点附近区域的处理取决于沿着形成这段冗余拓扑结构的"圆弧"长成的角度总和，若它接近$\pi$,则插入一段分割分开这段"圆弧"和剩余的几何区域，一方面此"圆弧"和插入的分割形成了一个2-边界简单区域，另一方面剩余的几何区域减少了一个$T$类中轴点，并增加了两个$C$类点。若整个区域只有一个中轴点$T$,则这个区域被视为1-边界简单区域。其他的情况$T$均可被视为\ref{sec:concavity-removal}中第二类拐角点:
%
%(2)\textbf{F类}\,若$C$类中轴点是ref{sec:concavity removal}中第二类拐角点，我们重新称它为$F$点，任何与$F$点相连的$J$点被重新定义为$FJ$点，即由$F-J$转化为$FJ$，四边形网格将沿此处连续地通过(图)。$FJ$或$I$点意味着两条边被合并为一条逻辑上的边，因此在所有的操作中，我们忽略任何的$FJ$或$I$点，直接考察与它们相连的$C,F,J$点。
%
%(3)\textbf{C类}\,若$C$点与$T$或$F$点相连，则此区域为1-边界简单区域(图)，若与$C$点相连，则此区域为2-边界简单区域(图)，若与$J$点相连，则我们之间考察：
%
%(4)\textbf{J类}\,若$J$点与$F$点相连，则更改$J$为$FJ$点，若与三个$C$点相连，则此区域为3-边界简单区域，若$J$点与两个$C$点相连，则被重新定义为$E$点，并忽略这两个$C$点(图)。产生所有的$E$点后，我们考查与剩余$J$点相邻的$C,E$点个数：若有一个$C$，两个$E$,则此区域为5-边界简单区域，若有三个$E$,则此区域为6-边界简单区域。若不满足如上所有情况，则此区域不能直接归为简单区域，将在(6)中处理。
%
%(5)\textbf{E类}\, 若与$E$相连的点为$C$点，则此区域为3-边界简单区域，而$E-E$结构的区域为4-边界简单区域。
%
%(6)\textbf{长链分割}\,以上操作后若还有$J-J$结构，则需要产生合适的分割，在分割两侧分别产生两个$E$点，分割后产生的两个子区域又可以归结为简单区域。若这条中轴线对应的边界有$F$点，则我们使用准则\ref{equ:split-concave}再次从Delaunay三角形中选取分割，此时$F$点被当作凹点处理。若无边界点，则以中轴线上的点为圆心，沿着中轴线产生一系列内接圆，并以长度为极值的直径作为分割。
%
%(7)\textbf{圆环}\,最后我们要检查是否有逻辑上的圆环结构存在，若有，则我们类似(6)产生两条分割，即可产生两个$E-E$结构，即4-边界简单区域。

\begin{definition}\label{def:prime}
	仅以$C$点为拐角点，根据逻辑上的边界数的不同，定义如下的简单区域(\todo{图})：
\end{definition}

\ref{sec:prime_meshing}节将会先进一步处理简单区域，再用整数规划的方法得到四边形网格。

\subsection{讨论与比较}\label{sec:discuss}

(ref fem2d)的方法先产生最优角度的非凹子区域，再根据子区域中轴线的结构进一步分解为简单区域进而四边形网格化。对任意输入的2维有界区域，它都能够生成四边形网格。

上节中，忽略$FJ$点是对中轴线的减支。\ref{sec:split-C-F}节将指出每个三支及以上中轴线的交汇点代表着至少一个奇异点的产生，因此对于有一定噪音的输入，忽略$FJ$点能有效地简化中轴线，避免生成不必要的奇异点。但对于抖动剧烈的噪音，此方法仍然会产生复杂的中轴线结构。我们先把较复杂的输入简化为多正N边形结构，再在它的多边形边界上做区域分割时，(1),(6)，(7)类的情况不会出现，奇异点的数目也会减少。
%通过改变N，我们也可以控制奇异点的多少
(\todo{图：有效剪支前、后，我们的方法})

（ref fogg）指出，由于中轴线对几何特征不够敏感，图中三种差异较大的形状具有相同的中轴线结构，所以(ref fem2d)的方法会把它们归结为$E-E$结构而最终产生没有奇异点但质量较差的四边形网格。但如果我们先把输入变形为多正八边形结构，三种形状的中轴线结构不同，因而会产生合适的奇异点，如果变形为多正方形结构，我们可以在同样没有奇异点的情况下产生质量更高的网格(\todo{图})。
 
\section{整数规划生成四边形网格}\label{sec:prime_meshing}
上节把2维任意有界区域细分为简单区域(\ref{def:prime})，本节先对简单区域中0-边界、1-边界、2-边界，6-边界区域做合理地分割，全部归结为3-边界、4-边界、5-边界简单区域，再利用(ref integer)提出的整数规划方法生成四边形网格。
\subsection{合理的3、4、5边形区域的产生}\label{sec:split-C-F}
与\ref{sec:cocavity-removal}节分割去除凹角的目标类似，我们要使新产生的角尽量接近直角,并且希望尽量少地引入新的顶点和短边。因此，我们先对非3、4、5-边界简单区域的边界采样做Delaunay三角化，再根据准则\ref{equ:split-concave}从所有与$F$点相连的内部边中选出最优的一条作为分割。分割在两个两个新的区域中产生的4个中轴点直接记为$C$点。显然此时\ref{equ:split-concave}中直角的整数倍$n_i$为1。\todo{图(split 0,1,2)给出了分割示意图}。

\textbf{注}\, 对于6-边界简单区域，为了保证一定能分割为3、4、5-边界区域，我们直接选取连接角度最大的$C$点和与它相对的两条边界上点的所有边，在其中选择最优的边作为分割，这样一定可以分解为\todo{图(3+5,4+5,4+4)中的一种}。
本文中采取的分割办法都是基于在Delaunay三角形中搜索最优边，但我们不需要为了找到最优分割过密地采点，因为\ref{sec:sus2d}中通过优化的方法可以优化所有的非拐角点的位置来提高四边形网格的质量，而所有的分割以及整数规划中产生的新的点主要是为了决定四边形网格的拓扑结构，并使得优化有较好的初始。
\subsection{整数规划生成四边形网格}\label{sec:quad-meshing}
给定3、4、5-边界的简单区域以及它们对应的四边形网格的样式后，每条边被细分成四边形网格边的数目决定了产生的四边形网格。以简单区域的边的细分数为整数变量，对不同的网格样式加上特定的约束，再使相邻区域的公共边界相容，最后以最小化所求细分数与一组特定值(比如用户给定的细分数，或基于之前的有限元分析的误差自动计算出的目标细分数(ref integer 6))之间的差异为目标，就可以求得一组最优的细分数。给定符合网格样式的细分数后，基于映射的方法(ref integer 3-5)通过把简单区域映射为3、4、5边形并产生四边形网格，再映射回原区域，即可得到质量较高的四边形网格。本节给出了类似(ref integer)的目标函数和线性约束，不同的是，
%直接在简单区域上产生四边形网格，再利用(ref untangling and smoothing)优化网格点的位置。
我们没有利用基于映射的方法决定内部点的位置，而是直接在简单区域上产生初始的四边形网格，再显式地以四边形网格质量为目标优化非拐角点的位置，得到最终的四边形网格。

\emph{变量}\, 简单区域的边界上只有$C,F$两种点(定义见\ref{def:medial=vertex})，每两个相邻的点形成一条边，设$x$为它的细分数。每个$C$点和与它最近的$C$点形成一条简单区域的逻辑边，它由至少一条边形成，它的总细分数记为$N$。

\emph{约束}\, 3、5-边界简单区域生成的四边形网格分别产生度为3、5的奇异点，而4-边界区域产生规则的四边形网格，没有奇异点。

3-边界区域的四边形网格样式如(\todo{图})所示，故需满足
\begin{equation}
\left(
\begin{array}{c}
N_1 \\ 
N_2 \\ 
N_3
\end{array}
\right) 
=
\left(
\begin{array}{ccc}
0 & 1 & 1 \\ 
1 & 0 & 1 \\ 
1 & 1 & 0
\end{array}
\right)
\cdot
\left(
\begin{array}{c}
n_1 \\ 
n_2 \\ 
n_3
\end{array} 
\right)
%\left($n_1,n_2,n_3$\leq $1$ \right)
\end{equation}
其中$N_i,n_i$分别为外部和内部细分数。实际上，变量$n_i$是冗余的，因为上式等价于
\begin{equation}
\left(
\begin{array}{c}
n_1 \\ 
n_2 \\ 
n_3
\end{array} 
\right)
=
\frac{1}{2}
\left(
\begin{array}{ccc}
-1 & 1 & 1 \\ 
1 & -1 & 1 \\ 
1 & 1 & -1
\end{array}
\right)
\cdot
\left(
\begin{array}{c}
N_1 \\ 
N_2 \\ 
N_3
\end{array}
\right) 
\end{equation}
又因为$n_i$是正整数，故上式等价于
 \begin{equation}        \label{equ:3side}                  
 \begin{cases}
 N_1+N_2>N_3\\
 N_2+N_3>N_1\\
 N_1+N_3>N_2\\
 N_1+N_2+N_3=2k(k\geq 1)\\
 \end{cases}
 \end{equation}
 前三个式子保证了内部细分数为正，最后一个式子保证内部细分数为整数。
 
 4-边界区域的约束很简单，只需保证相对的逻辑边细分数相等即可(\todo{图})，即
 \begin{equation}\label{equ:4side}
\begin{cases}
N_1=N_3\\
N_2=N_4\\
\end{cases}
 \end{equation}
 
 5-边界区域的约束与3-边界类似，根据其四边形网格样式(\todo{图})，我们有
 \begin{equation}
 \left(
 \begin{array}{c}
 N_1 \\ 
 N_2 \\ 
 N_3 \\
 N_4 \\
 N_5
 \end{array}
 \right) 
 =
 \left(
 \begin{array}{ccccc}
 0 & 1 & 0 & 0 & 1 \\ 
 1 & 0 & 1 & 1 & 0 \\ 
 0 & 1 & 0 & 1 & 0 \\ 
 0 & 0 & 1 & 0 & 1 \\ 
 1 & 0 & 0 & 1 & 0
 \end{array} 
 \right)
 \cdot
 \left(
 \begin{array}{c}
 n_1 \\ 
 n_2 \\ 
 n_3 \\ 
 n_4 \\
 n_5 
 \end{array} 
 \right)
 \end{equation}
 其中$N_i,n_i$分别为外部和内部细分数，同样地，上式等价于
 \begin{equation}        \label{equ:5side}                  
 \begin{cases}
 N_1+N_2+N_3 > N_4+N_5\\
N_2+N_3+N_4 > N_5+N_1\\
 N_3+N_4+N_5 > N_1+N_2\\
N_4+N_5+N_1 > N_2+N_3\\
N_5+N_1+N_2 > N_3+N_4\\
N_1+N_2+N_3+N_4+N_5=2k(k\geq 1)\\
 \end{cases}
 \end{equation}
 前4个式子保证了内部细分数为正，最后一个式子保证内部细分数为整数。
 
若只对每个简单区域加上独立的约束，则可能在公共边上产生不一致的结果(\todo{图不相容->相容})。因此，相容约束要求每条公共边的细分数必须同时满足它所在两个区域的约束。由于我们在区域的细分过程中始终维持一个半边数据结构(ref halfedge data structure, if any)，所以只要对每一组方向相反的半边设一个细分数变量，就可自动满足区域间的相容性。

\emph{目标函数和其他约束}\,我们希望产生质量较高且尽量稀疏的四边形网格，故对于每个简单区域，令其最短的边的目标细分数为1，对其余边长与最短边长的比值向下取整，作为它们的目标细分数(至少为1)，然后规定解得的细分数不小于目标，并让它们和目标尽量接近。设$x_i$的目标细分数为$d_i$,则目标函数为
\begin{equation}\label{equ:targetf}
\min \sum_{i=1}^{n} x_i
\end{equation}
再增加如下的约束
\begin{equation} \label{equ:target-constrain}
x_i \geq d_i
\end{equation}

这样，以\ref{equ:3side},\ref{equ:5side},\ref{equ:target-constrain}为线性约束，\ref{targetf}为线性目标函数，我们用MOSEK库(ref mosek)可以非常快的得到最优解。求出每条边的细分数后，我们直接在均分边界得到不是拐角点的边界点。对于4-边界区域，直接连接对边上的对应点，并两组对边连线的交点作为内部点，即得到四边形网格。对于3、5-边界简单区域，先利用边界上的$C$点求出它们的中心作为奇异点，再连接产生内部边，进而分别分割为3个和5个4-边界简单区域，进而得到四边形网格。这些初始的四边形网格质量较差，且可能含有翻转单元，我们再利用\ref{sec:sus-ver-quad}节的优化算法改变非拐角点的位置，得到有效且高质量的四边形网格。最后，我们可以根据需要通过把四边形单元一分为四得到更密的网格。
